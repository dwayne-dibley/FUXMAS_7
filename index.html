<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FUXMAS 7, 2025 — Private Supabase Slideshow</title>

<!-- Supabase JS v2 (public CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

<style>
  :root{
    --bg:#0f1115;
    --card:#0f1720;
    --text:#e6eef8;
    --muted:#9fb0c8;
    --accent:#ffca28;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--text);margin:0;padding:20px;line-height:1.35}
  .container{max-width:1100px;margin:0 auto}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.6);margin-bottom:18px}
  h1{margin:0 0 8px;font-size:1.5rem}
  .meta{color:var(--muted);font-size:0.9rem;margin-bottom:12px}
  table.schedule{width:100%;border-collapse:collapse;font-size:0.95rem}
  table.schedule th, table.schedule td{padding:8px 10px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left}
  table.schedule th{background:rgba(255,255,255,0.02);font-weight:600;color:var(--muted)}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}

  .slideshow{display:flex;gap:18px;align-items:center;flex-wrap:wrap}
  .viewer{flex:1 1 600px;height:480px;background:#081018;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
  .viewer img{max-width:100%;max-height:100%;object-fit:contain;display:block}
  .controls{display:flex;flex-direction:column;gap:8px;min-width:230px}
  .btn{padding:10px 12px;border-radius:8px;background:rgba(255,255,255,0.03);color:var(--text);border:1px solid rgba(255,255,255,0.03);cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .row{display:flex;gap:8px}
  .uploader{margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type=file]{display:none}
  .filelabel{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px dashed rgba(255,255,255,0.03)}
  .note{font-size:0.85rem;color:var(--muted);margin-top:8px}
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>FUXMAS 7, 2025</h1>
      <p class="meta">Source doc (local path): <a href="/mnt/data/FUXMAS 7 - 2025.docx" target="_blank" rel="noopener noreferrer">/mnt/data/FUXMAS 7 - 2025.docx</a></p>

      <!-- Reconstructed table (hyperlink targets preserved) -->
      <div id="tableWrap">
        <table class="schedule">
<tr><th>TIME</th><th>TIME</th><th>PINT</th><th>LOCATION</th><th>NOTES</th><th>WALKING</th><th>OTHER</th></tr>
<tr><td>11:00</td><td>11:00</td><td>1</td><td><a href="https://www.google.com/maps/place/The+Reveley/" target="_blank">The Reveley</a></td><td>FUXMAS 2</td><td></td><td></td></tr>
<tr><td>11:30</td><td>11:30</td><td></td><td><a href="https://maps.app.goo.gl/PDte6p132LbMhdd2A" target="_blank">Walk</a></td><td></td><td>2 min</td><td></td></tr>
<tr><td>11:30</td><td>11:30</td><td>2</td><td><a href="https://www.google.com/maps/place/The+Island+at+Elizabeth+Quay/" target="_blank">The Island at Elizabeth Quay</a></td><td>FUXMAS 2</td><td></td><td></td></tr>
<tr><td>11:55</td><td></td><td></td><td><a href="https://www.google.com/maps/place/Beer+Corner/" target="_blank">Walk and Blue Cat</a></td><td></td><td>3 min</td><td>3 min</td></tr>
<tr><td>12:00</td><td>3</td><td>3</td><td><a href="https://www.google.com/maps/place/The+Petition/" target="_blank">The Petition</a></td><td>FUXMAS 1, 3 &amp; 6</td><td></td><td></td></tr>
<tr><td>12:30</td><td></td><td></td><td></td><td>Next one? Leave Petition @1300</td><td>3 min<br>1 min</td><td>12 min</td></tr>
<tr><td>12:50</td><td>4</td><td></td><td><a href="https://www.google.com/maps/place/Long+Neck/" target="_blank">Long Neck</a></td><td>FUXMAS 3</td><td></td><td></td></tr>
<tr><td>13:20</td><td></td><td></td><td></td><td>Uber</td><td></td><td>6 min</td></tr>
<tr><td>13:30</td><td>5, 6</td><td></td><td><a href="https://www.google.com/maps/place/Blasta+Gastrobrewery/" target="_blank">Blasta brewing</a></td><td>FUXMAS 2</td><td></td><td></td></tr>
<tr><td>14:45</td><td>7</td><td></td><td><a href="https://www.google.com/maps/place/Rocky+Ridge+Burswood/" target="_blank">Rocky Ridge</a></td><td>NEW</td><td></td><td>Train</td></tr>
<tr><td>15:15</td><td></td><td></td><td></td><td></td><td>6 min<br>3 min</td><td>9 min</td></tr>
<tr><td>15:35</td><td>8</td><td></td><td><a href="https://www.google.com/maps/place/Stories/" target="_blank">Stories Pourhouse</a></td><td>NEW</td><td></td><td>Walk</td></tr>
<tr><td>16:10</td><td></td><td></td><td></td><td></td><td></td><td>3 min</td></tr>
<tr><td>16:15</td><td>9</td><td></td><td><a href="https://www.google.com/maps/place/Ezra+Pound/" target="_blank">Ezra Pound</a></td><td>FUXMAS 6</td><td></td><td>Walk</td></tr>
<tr><td>16:50</td><td></td><td></td><td></td><td></td><td>2 min</td><td></td></tr>
<tr><td>16:55</td><td>10</td><td></td><td><a href="https://www.google.com/maps/place/Glastonburys+Bar+%26+Kitchen/" target="_blank">Glastonbury bar and kitchen</a></td><td>NEW</td><td></td><td>Walk</td></tr>
<tr><td>17:30</td><td></td><td></td><td></td><td></td><td>1 min</td><td></td></tr>
<tr><td>17:30</td><td>11</td><td></td><td><a href="https://www.google.com/maps/place/Edward+and+Ida's/" target="_blank">Edward and Ida’s</a></td><td>FUXMAS 6</td><td></td><td>Walk</td></tr>
<tr><td>18:10</td><td></td><td></td><td></td><td></td><td>5 min</td><td></td></tr>
<tr><td>18:15</td><td>12</td><td></td><td><a href="https://www.google.com/maps/place/Northbridge+Brewing+Company/" target="_blank">Northbridge Brewing Company</a></td><td>FUXMAS 1</td><td></td><td></td></tr>
<tr><td>18:50</td><td>13</td><td></td><td><a href="https://www.google.com/maps/place/Sir+Henry's/" target="_blank">Sir Henry’s</a></td><td>NEW</td><td></td><td>Walk</td></tr>
<tr><td>19:30</td><td></td><td></td><td></td><td></td><td>4 min</td><td></td></tr>
<tr><td>19:35</td><td></td><td></td><td><a href="https://maps.app.goo.gl/iWGqzNUAu2XnYq4ZA" target="_blank">Prestige Kebab House</a></td><td>NOMNOMNOM</td><td></td><td>Walk</td></tr>
<tr><td>19:55</td><td></td><td></td><td></td><td></td><td>3 min</td><td></td></tr>
<tr><td>20:00</td><td>14</td><td></td><td><a href="https://www.google.com/maps/place/Joe's+Juice+Joint/" target="_blank">Joe’s Juice Joint</a></td><td>NEW</td><td></td><td></td></tr>
</table>
      </div>
    </div>

    <!-- Slideshow & Uploader -->
    <div class="card">
      <h2>Private Slideshow (Supabase)</h2>
      <p class="meta">Uploads go to your private Supabase bucket <code>fuxmas-images</code>. Signed URLs are requested so images stay private until displayed. New images appear automatically (every 30s).</p>

      <div class="slideshow">
        <div class="viewer" id="viewer" aria-live="polite">
          <div id="placeholder" style="color:var(--muted);text-align:center;padding:12px">No images yet.</div>
          <img id="slideImg" src="" alt="" style="display:none" />
        </div>

        <div class="controls">
          <div class="row">
            <button class="btn" id="prevBtn">⟨ Prev</button>
            <button class="btn" id="playPauseBtn">Pause</button>
            <button class="btn" id="nextBtn">Next ⟩</button>
          </div>

          <div class="row">
            <button class="btn" id="reloadBtn">Reload images</button>
            <button class="btn" id="uploadOpenBtn">Choose file to upload</button>
          </div>

          <div class="meta" id="imageCounter">0 images</div>

          <div class="uploader">
            <label for="fileInput" class="filelabel">Choose files to upload</label>
            <input id="fileInput" type="file" accept="image/png,image/jpeg" multiple />
          </div>

          <div class="note">Upload limit per file: 20 MB. Signed URLs expire in 3600s (1 hour).</div>
        </div>
      </div>
    </div>

    <footer class="note">Built on Supabase (private bucket). Make sure storage policy allows anon INSERT and SELECT for <code>fuxmas-images</code>.</footer>
  </div>

<script>
/*
  CONFIGURATION: Your Supabase project details (provided)
*/
const SUPABASE_URL = "https://dmqgpcsubaegmdaptici.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtcWdwY3N1YmFlZ21kYXB0aWNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5ODM2OTIsImV4cCI6MjA3OTU1OTY5Mn0.dMbp4f1xBxrBAc1Coh7FV1fTBjiSG3yfBcRerUCS6ko";

const BUCKET = "fuxmas-images";
const SIGNED_URL_EXPIRES = 3600; // seconds (1 hour)
const IMAGE_REFRESH_MS = 30000;   // 30 seconds
const SLIDE_INTERVAL_MS = 10000;  // 10 seconds

// Initialize Supabase client
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// UI elements
const slideImg = document.getElementById('slideImg');
const placeholder = document.getElementById('placeholder');
const imageCounter = document.getElementById('imageCounter');
const fileInput = document.getElementById('fileInput');
const uploadOpenBtn = document.getElementById('uploadOpenBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const playPauseBtn = document.getElementById('playPauseBtn');
const reloadBtn = document.getElementById('reloadBtn');

let images = []; // array of {name, signedUrl}
let current = 0;
let playing = true;
let slideTimer = null;
let reloadTimer = null;

// --- Helpers ---
function showPlaceholder() {
  placeholder.style.display = 'block';
  slideImg.style.display = 'none';
  imageCounter.textContent = '0 images';
}
function showImage(idx){
  if(images.length === 0){ showPlaceholder(); return; }
  current = ((idx % images.length) + images.length) % images.length;
  slideImg.src = images[current].signedUrl;
  slideImg.alt = images[current].name;
  slideImg.style.display = 'block';
  placeholder.style.display = 'none';
  imageCounter.textContent = `${current+1} / ${images.length}`;
}

// --- Storage: list files and create signed urls ---
async function refreshImageList(){
  try {
    // list files in the bucket root
    const { data, error, status } = await supabaseClient.storage.from(BUCKET).list('', {limit: 100, sortBy: { column: 'name', order: 'asc' }});
    if (error && status !== 406) { console.error('List error', error); return; }
    if (!data || data.length === 0) { images = []; showPlaceholder(); return; }

    // filter to PNG/JPG/JPEG
    const files = data.filter(f => /\.(png|jpe?g)$/i.test(f.name));
    // For each file we ask Supabase for a signed URL
    const signedPromises = files.map(async f => {
      // createSignedUrl requires SELECT permission on objects for the anon role (see notes).
      const { data: signedData, error: signErr } = await supabaseClient.storage.from(BUCKET).createSignedUrl(f.name, SIGNED_URL_EXPIRES);
      if (signErr) {
        console.warn('createSignedUrl error for', f.name, signErr);
        return null;
      }
      return { name: f.name, signedUrl: signedData.signedUrl, updated_at: f.updated_at || '' };
    });

    const signedResults = await Promise.all(signedPromises);
    images = signedResults.filter(Boolean);
    // sort by name (or updated_at) if you prefer:
    images.sort((a,b) => a.name.localeCompare(b.name));
    if(images.length === 0) { showPlaceholder(); return; }
    // If current index out of range, reset to 0
    if (current >= images.length) current = 0;
    showImage(current);
  } catch (err) {
    console.error('refreshImageList error', err);
  }
}

// --- Uploading ---
async function uploadFiles(fileList){
  if(!fileList || fileList.length === 0) return;
  for(const file of fileList){
    // Limit file size to 20 MB in client
    if(file.size > 20 * 1024 * 1024){ alert(`File ${file.name} too large (max 20MB).`); continue; }

    // create a safe filename with timestamp prefix to avoid collisions
    const timestamp = Date.now();
    const safeName = `${timestamp}__${file.name.replace(/\s+/g,'_')}`;

    try {
      const { data, error } = await supabaseClient.storage.from(BUCKET).upload(safeName, file, {
        cacheControl: '3600',
        upsert: false
      });
      if (error) {
        console.error('Upload error', error);
        alert('Upload failed: ' + (error.message || 'unknown'));
      } else {
        // Optionally refresh the list immediately after successful upload
        await refreshImageList();
      }
    } catch (err) {
      console.error('uploadFiles error', err);
    }
  }
}

// --- Slideshow controls ---
function nextImage(){ if(images.length) showImage(current+1); }
function prevImage(){ if(images.length) showImage(current-1); }
function startSlideshow(){ stopSlideshow(); slideTimer = setInterval(nextImage, SLIDE_INTERVAL_MS); playing = true; playPauseBtn.textContent = 'Pause'; }
function stopSlideshow(){ if(slideTimer){ clearInterval(slideTimer); slideTimer = null; } playing = false; playPauseBtn.textContent = 'Play'; }
function togglePlay(){ if(playing) stopSlideshow(); else startSlideshow(); }

// UI hooks
nextBtn.addEventListener('click', () => { nextImage(); if(playing){ stopSlideshow(); startSlideshow(); } });
prevBtn.addEventListener('click', () => { prevImage(); if(playing){ stopSlideshow(); startSlideshow(); } });
playPauseBtn.addEventListener('click', togglePlay);
reloadBtn.addEventListener('click', refreshImageList);

// file chooser UI
uploadOpenBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', (ev) => {
  const files = Array.from(ev.target.files || []);
  const imagesOnly = files.filter(f => /\.(png|jpe?g)$/i.test(f.name));
  if(imagesOnly.length === 0) { alert('Select PNG or JPG/JPEG files'); return; }
  uploadFiles(imagesOnly);
  // clear input so same files can be selected again if needed
  ev.target.value = '';
});

// initialization
(async function init(){
  showPlaceholder();
  await refreshImageList();
  startSlideshow();
  // auto refresh the list every IMAGE_REFRESH_MS
  reloadTimer = setInterval(refreshImageList, IMAGE_REFRESH_MS);
})();
</script>
</body>
</html>
